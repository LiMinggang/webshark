<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">

	<title>${CAPTURE_FILE} - webshark ${WEBSHARK_VER}</title>

	<link rel="stylesheet" href="css/webshark.css" type="text/css">
	<link rel="stylesheet" href="css/awesomplete.css" type="text/css">

	<script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
	<script src="js/webshark-awesomplete.js" type="text/javascript"></script>
	<script src="js/webshark-clusterize.js"></script>
	<script src="js/webshark.js" type="text/javascript"></script>

	<script type="text/javascript">
		var ws_columns = null;

		var ws_ftypes = [ ];
		var ws_stats = [ ];
		var ws_convs = [ ];

		var ws_pref = { };

		var ws_default_pref =
		{
			columns:
			[
				{ "No.":          "%m" },
				{ "Time":         "%t" },
				{ "Source":       "%s" },
				{ "Destination":  "%d" },
				{ "Protocol":     "%p" },
				{ "Length":       "%L" },
				{ "Info":         "%i" },
//				{ "tcp.stream": "tcp.stream:0" },
			],
		};

		var capture_filter_complete = null;

		function create_tap_menu(id, taps)
		{
			var node = document.getElementById(id);

			for (var i = 0; i < taps.length; i++)
			{
				var li = document.createElement("li");
				var a = document.createElement("a");

				var title = taps[i].name;
				var tap = taps[i].tap;

				a.appendChild(document.createTextNode(title));
				a.setAttribute("target", "_blank");
				a.setAttribute("href", window.location.href + "&tap=" + tap);
				// a.addEventListener("click", popup_on_click);

				li.appendChild(a);
				node.appendChild(li);
			}
		}

		function parse_query(query)
		{
			var result = { };

			if (query)
			{
				var opts = query.split("&");
				for (var i = 0; i < opts.length; i++)
				{
					var arr = opts[i].split("=");
					result[arr[0]] = decodeURIComponent(arr[1]);
				}
			}

			return result;
		}

		var field_complete_cache = { };

		function sharkd_complete_field_cache(field, fun)
		{
			var field_with_dot = (field.indexOf('.') != -1);

			var str = field;

			if (field_with_dot)
			{
				while (str.indexOf('.') != -1)
				{
					var data = field_complete_cache[str];
					if (data)
						return fun(data);

					str = str.slice(0, str.length - 1);
				}
			}
			else
			{
				while (str.length > 0)
				{
					var data = field_complete_cache[str];
					if (data)
						return fun(data);

					str = str.slice(0, str.length - 1);
				}
			}

			webshark_json_get('req=complete&field=' + encodeURIComponent(field),
				function(data)
				{
					data = data['field'];
					if (data == undefined)
						return;

					data.sort(function(a, b) { return a['f'] < b['f'] ? -1 : 1; });

					field_complete_cache[field] = data;

					fun(data);
				});
		}

		function filter_input_extractor(filter)
		{
			var txt = filter.value;

			var pos_end = filter.selectionStart;
			var pos_start = pos_end;

			while (pos_start > 0)
			{
				var ch = txt.charAt(--pos_start);

				var ch_field = ((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z') || (ch >= '0' && ch <= '9') || (ch == '.') || (ch == '_') || (ch == '-'));

				if (!ch_field)
				{
					pos_start++;
					break;
				}
			}

			var result =
				[
					/* current text, before current, after current */
					txt.slice(pos_start, pos_end),
					txt.slice(0, pos_start),
					txt.slice(pos_end)
				];

			return result;
		}

		function checkfilter(el)
		{
			if (el.value.length >= 2)
			{
				var fields = filter_input_extractor(el);

				sharkd_complete_field_cache(fields[0],
					function(data)
					{
						var list = [ ];

						for (var i = 0; i < data.length; i++)
						{
							var field_name = data[i]['f'];
							var field_descr = "";

							if (data[i]['n'])
								field_descr = data[i]['n'] + ' (' + ws_ftypes[data[i]['t']] + ')';

							list[i] =
								{
									label: field_name,
									descr: field_descr,
									value: fields[1] + field_name + fields[2]
								};
						}

						capture_filter_complete.list = list;
						// capture_filter_complete.evaluate();
					});
			}

			if (el.value == '')
			{
				el.className = '';
				return;
			}

			webshark_json_get('req=check&filter=' + encodeURIComponent(el.value),
				function(data)
				{
					if (data['filter'] == 'ok')
						el.className = 'ws_gui_text_valid';
					else if (data['filter'] == 'deprecated')
						el.className = 'ws_gui_text_deprecated';
					else
						el.className = 'ws_gui_text_invalid';
				});
		}

		function run()
		{
			var opt = parse_query(window.location.href.split("?")[1]);

			_webshark_file = opt['file'];
			document.title = document.title.replace("${CAPTURE_FILE}", _webshark_file);

			var frame = opt['frame'];
			var tap = opt['tap'];

			capture_filter_complete = new Awesomplete(document.getElementById("capture_filter"),
				{
					filter: Awesomplete.FILTER_STARTSWITH,
					getvalue: function(f) { return filter_input_extractor(f)[0]; },
					maxItems: 16,
					item: function (text, input)
						{
							var html = input === '' ?
								text :
								text.replace(RegExp("^" + Awesomplete.$.regExpEscape(input.trim()), "gi"), "<mark>$&</mark>");

							if (text['descr'])
								html += "<span style='float: right; font-size: 12px;'>" + text['descr'] + "</span>";

							return Awesomplete.$.create("li",
							{
								innerHTML: html,
								"aria-selected": "false"
							});
						}
				});

			if (tap) {
				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';
				document.getElementById('ws_packet_detail_view').style.display = 'none';
				document.getElementById('ws_packet_bytes_view').style.display = 'none';

				document.getElementById('toolbar_tap').style.display = 'block';

				webshark_load_tap(tap.split(","));

			} else if (frame) {
				webshark_load_frame(frame);

				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';

				document.getElementById('toolbar_frame').style.display = 'block';

			} else {
				var filter = opt['filter'];

				if (filter)
				{
					var el_filter = document.getElementById('capture_filter');

					el_filter.value = filter;
					checkfilter(el_filter);
				}

				if (opt['hide_menu'] == undefined)
				{
					create_tap_menu('cap_menu', ws_taps);
					create_tap_menu('cap_menu', ws_stats);
					create_tap_menu('cap_menu', ws_convs);
				}

				webshark_load_capture(filter, ws_columns);
			}

			document.getElementById("ws_div").style.display = "block";
		}

		function load_preferences()
		{
			for (var key in ws_default_pref)
			{
				if (ws_pref[key] == undefined)
					ws_pref[key] = ws_default_pref[key];
			}
		}

		function render_interval(mode)
		{
			_webshark_interval_mode = mode;
			webshark_render_interval();
		}

		function load()
		{
			_webshark_url = '/webshark/json?';
			_webshark_interval_mode = "bps";

			_webshark_frames_html = new Clusterize({
				rows: [],
				rows_in_block: 25,
				tag: 'tr',
				scrollId: 'ws_packet_list_view',
				contentId: 'packet_list_frames'
			});

			load_preferences();

			webshark_json_get('req=info',
				function(data)
				{
					ws_taps  = data['taps'];
					ws_stats = data['stats'];
					ws_convs = data['convs'];
					ws_ftypes = data['ftypes'];

					var columns_default = [ "%m", "%t", "%s", "%d", "%p", "%L", "%i" ];
					var columns_title   = [ ];
					var columns_pref    = [ ];

					document.title = document.title.replace("${WEBSHARK_VER}", data['version']);

					for (var col = 0; col < ws_pref.columns.length; col++)
					{
						var col_title = "";
						var col_format = "";
						var col_format_idx = -1;

						for (col_title in ws_pref.columns[col]) { col_format = ws_pref.columns[col][col_title]; }
						columns_title.push(col_title);

						if (col >= columns_default.length || columns_default[col] != col_format)
						{
							ws_columns = columns_pref;
						}

						/* map from column format to integer */
						var ws_d_columns = data['columns'];
						for (var col_map = 0; col_map < ws_d_columns.length; col_map++)
						{
							if (ws_d_columns[col_map].format == col_format)
							{
								col_format_idx = col_map;
							}
						}

						if (col_format_idx != -1)
							columns_pref.push(col_format_idx);
						else
							columns_pref.push(col_format);
					}

					webshark_render_columns(columns_title);
					run();
				});
		}

	</script>
</head>

<body onload="load()"><div id="ws_div" style="display: none;">
	<div id="toolbar_capture">
		<ul class="menu" id="cap_menu"></ul>
		<div style="clear: both;"></div>
		Frame filter: <input id="capture_filter" type='text' onchange='webshark_load_capture(this.value, ws_columns);' oninput='checkfilter(this)' style='width: 800px;' />
		<div style="float: right; border: 1px solid grey;">
			<div id="capture_interval">
				<svg width="620" height="100"></svg>
			</div>
			<input type="radio" name="interval_mode" onchange="render_interval('bps')" value="bps" checked="checked"> bytes/seconds
			<input type="radio" name="interval_mode" onchange="render_interval('fps')" value="fps"> frames/seconds
		</div>
		<div style="clear: both;"></div>
	</div>

	<div id="toolbar_frame" style="display: none;">
		Placeholder for frame toolbar
	</div>

	<div id="toolbar_tap" style="display: none;">
		Placeholder for taps toolbar
	</div>

	<div id="ws_packet_list_view" style='height: 350px; overflow: auto; border: 2px solid grey;'>
		<table id="packet_list" style="width: 100%;">
			<thead id="packet_list_header">
				<!-- <tr><th>No.</th></tr> -->
			</thead>
			<tbody id="packet_list_frames">
				<!--- <tr><td>1</td><td>2h</td></tr> -->
			</tbody>
		</table>
	</div>

	<div id="ws_packet_detail_view" style='overflow: auto; width: 100%; height: 250px; border: 2px solid grey;'>
Select frame
	</div>

	<div id="ws_packet_bytes_view" style='overflow: auto; width: 100%; height: 200px; border: 2px solid grey;'>
Select frame
	</div>

</div></body>
</html>
