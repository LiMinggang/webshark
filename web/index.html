<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">

	<title>webshark ${WEBSHARK_VER}</title>

	<link rel="stylesheet" href="css/webshark.css" type="text/css">
	<link rel="stylesheet" href="css/awesomplete.css" type="text/css">

	<script src="https://d3js.org/d3.v4.min.js" type="text/javascript"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/wavesurfer.js/1.3.2/wavesurfer.min.js" type="text/javascript"></script>

	<script src="js/webshark-awesomplete.js" type="text/javascript"></script>
	<script src="js/webshark-clusterize.js"></script>
	<script src="js/webshark.js" type="text/javascript"></script>

	<script type="text/javascript">
		var ws_ftypes = [ ];
		var ws_taps  = [ ];
		var ws_stats = [ ];
		var ws_nstat = [ ];
		var ws_eo    = [ ];
		var ws_follow= [ ];
		var ws_seqa  = [ ];
		var ws_srt   = [ ];
		var ws_rtd   = [ ];
		var ws_convs = [ ];

		var ws_pref = { };

		var ws_default_pref =
		{
			columns:
			[
				{ "No.":          "%m" },
				{ "Time":         "%t" },
				{ "Source":       "%s" },
				{ "Destination":  "%d" },
				{ "Protocol":     "%p" },
				{ "Length":       "%L" },
				{ "Info":         "%i" },
//				{ "tcp.stream": "tcp.stream:0" },
			],

			layout_optimize_height: true
		};

		var capture_filter_complete = null;

		function setup_user_toolbar(user)
		{
			if (user)
			{
				var el = document.getElementById('user_login');
				el.innerHTML = user;
				el.style.display = 'inline';

				document.getElementById('user_registered').style.display = "inline";
			}
			else
			{
				document.getElementById('user_anon').style.display = "inline";
			}
		}

		function setup_frame_toolbar()
		{
			document.getElementById('toolbar_frame').style.display = 'block';

			var comment_a = document.getElementById('toolbar_frame_comment');

			/* Edit comment */
			{
				comment_a.addEventListener("click", webshark_frame_comment_on_click);
				comment_a.addEventListener("mouseover", webshark_frame_comment_on_over);

				var glyph = webshark_glyph_img('comment', 32);
				glyph.setAttribute('alt', 'Comment');
				glyph.setAttribute('title', 'Comment');
				dom_set_child(comment_a, glyph);
			}

			_webshark_on_frame_change = function (framenum, data)
			{
				comment_a['data_ws_frame'] = framenum;
			};
		}

		function create_tap_menu(id, taps)
		{
			var node = document.getElementById(id);

			for (var i = 0; i < taps.length; i++)
			{
				var li = document.createElement("li");
				var a = document.createElement("a");

				var title = taps[i].name;
				var tap = taps[i].tap;

/*
TODO: Give user possible to generate multiple reports by selecting checkboxes
				var inp = document.createElement('input');
				inp.setAttribute('type', 'checkbox');
				a.appendChild(inp);
 */

				a.appendChild(document.createTextNode(title));
				a.setAttribute("target", "_blank");
				a.setAttribute("href", window.location.href + "&tap=" + tap);
				a.setAttribute("id", "menu_tap_" + tap);
				// a.addEventListener("click", popup_on_click);

				li.appendChild(a);
				node.appendChild(li);
			}
		}

		function parse_query(query)
		{
			var result = { };

			if (query)
			{
				var opts = query.split("&");
				for (var i = 0; i < opts.length; i++)
				{
					var arr = opts[i].split("=");
					result[arr[0]] = decodeURIComponent(arr[1]);
				}
			}

			return result;
		}

		var field_complete_cache = { };

		function sharkd_complete_field_cache(field, fun)
		{
			var field_with_dot = (field.indexOf('.') != -1);

			var str = field;

			if (field_with_dot)
			{
				while (str.indexOf('.') != -1)
				{
					var data = field_complete_cache[str];
					if (data)
						return fun(data);

					str = str.slice(0, str.length - 1);
				}
			}
			else
			{
				while (str.length > 0)
				{
					var data = field_complete_cache[str];
					if (data)
						return fun(data);

					str = str.slice(0, str.length - 1);
				}
			}

			webshark_json_get(
				{
					req: 'complete',
					field: field
				},
				function(data)
				{
					data = data['field'];
					if (data == undefined)
						return;

					data.sort(function(a, b) { return a['f'] < b['f'] ? -1 : 1; });

					field_complete_cache[field] = data;

					fun(data);
				});
		}

		function filter_input_extractor(filter)
		{
			var txt = filter.value;

			var pos_end = filter.selectionStart;
			var pos_start = pos_end;

			while (pos_start > 0)
			{
				var ch = txt.charAt(--pos_start);

				var ch_field = ((ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z') || (ch >= '0' && ch <= '9') || (ch == '.') || (ch == '_') || (ch == '-'));

				if (!ch_field)
				{
					pos_start++;
					break;
				}
			}

			var result =
				[
					/* current text, before current, after current */
					txt.slice(pos_start, pos_end),
					txt.slice(0, pos_start),
					txt.slice(pos_end)
				];

			return result;
		}

		function checkfilter(el)
		{
			if (el.value.length >= 2)
			{
				var fields = filter_input_extractor(el);

				sharkd_complete_field_cache(fields[0],
					function(data)
					{
						var list = [ ];

						for (var i = 0; i < data.length; i++)
						{
							var field_name = data[i]['f'];
							var field_descr = "";

							if (data[i]['n'])
								field_descr = data[i]['n'] + ' (' + ws_ftypes[data[i]['t']] + ')';

							list[i] =
								{
									label: field_name,
									descr: field_descr,
									value: fields[1] + field_name + fields[2]
								};
						}

						capture_filter_complete.list = list;
						// capture_filter_complete.evaluate();
					});
			}

			if (el.value == '')
			{
				el.className = '';
				return;
			}

			webshark_json_get(
				{
					req: 'check',
					filter: el.value
				},
				function(data)
				{
					if (data['filter'] == 'ok')
						el.className = 'ws_gui_text_valid';
					else if (data['filter'] == 'deprecated')
						el.className = 'ws_gui_text_deprecated';
					else
						el.className = 'ws_gui_text_invalid';
				});
		}

		function set_filter(filter)
		{
			_webshark.setFilter(filter);
		}

		function set_field_filter(filter)
		{
			_webshark_prototree_html.setFieldFilter(filter);
		}

		function run()
		{
			var opt = parse_query(window.location.href.split("?")[1]);

			_webshark_file = opt['file'];

			var frame = opt['frame'];
			var tap = opt['tap'];
			var follow = opt['follow'];
			var filter = opt['filter'];
			var dir = opt['dir'];

			capture_filter_complete = new Awesomplete(document.getElementById("capture_filter"),
				{
					filter: Awesomplete.FILTER_STARTSWITH,
					getvalue: function(f) { return filter_input_extractor(f)[0]; },
					maxItems: 0,
					maxHeight: '250px',
					item: function (text, input)
						{
							var html = input === '' ?
								text :
								text.replace(RegExp("^" + Awesomplete.$.regExpEscape(input.trim()), "gi"), "<mark>$&</mark>");

							if (text['descr'])
								html += "<span style='float: right; font-size: 12px;'>" + text['descr'] + "</span>";

							return Awesomplete.$.create("li",
							{
								innerHTML: html,
								"aria-selected": "false"
							});
						}
				});

			if (follow) {

				document.title = "Following " + follow + ' (' + filter + ') ' + _webshark_file + " - " + document.title;

				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';
				document.getElementById('ws_packet_detail_view').style.display = 'none';
				document.getElementById('ws_packet_bytes_view').style.display = 'none';

				document.getElementById('toolbar_tap').style.display = 'block';

				webshark_load_follow(follow, filter);

			} else if (tap) {
				document.title = "Report of " + _webshark_file + " - " + document.title;

				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';
				document.getElementById('ws_packet_detail_view').style.display = 'none';
				document.getElementById('ws_packet_bytes_view').style.display = 'none';

				document.getElementById('toolbar_tap').style.display = 'block';

				webshark_load_tap(tap.split(";"));

			} else if (frame) {
				document.title = _webshark_file + " #" + frame + " - " + document.title;

				webshark_load_frame(frame, true);

				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';

				setup_frame_toolbar();

			} else if (_webshark_file) {
				var new_title = _webshark_file + " - " + document.title;

				document.title = "Loading: " + new_title;

				setup_frame_toolbar();

				if (ws_pref['layout_optimize_height'] == true)
				{
					document.getElementById('ws_packet_detail_view').style.width = '57%';
					document.getElementById('ws_packet_bytes_view').style.width = '42%';
					document.getElementById('ws_packet_bytes_view').style.height =
						document.getElementById('ws_packet_detail_view').style.height;
				}

				_webshark.load(_webshark_file, function(data)
				{
				document.title = new_title;

				if (filter)
				{
					var el_filter = document.getElementById('capture_filter');

					el_filter.value = filter;
					checkfilter(el_filter);
				}

				/* Back to file list */
				{
					var back_a = document.getElementById('toolbar_capture_files');
					back_a.setAttribute("href", "index.html");

					var glyph = webshark_glyph_img('files', 16);
					glyph.setAttribute('alt', 'Back to file list');
					glyph.setAttribute('title', 'Back to file list');
					dom_set_child(back_a, glyph);
				}

				/* Link to download capture file */
				{
					var down_a = document.getElementById('toolbar_capture_down');
					down_a.setAttribute("target", "_blank");
					down_a.setAttribute("href", _webshark_url + 'req=download&capture=' + _webshark_file  + "&token=self");
					down_a.addEventListener("click", popup_on_click_a);

					var glyph = webshark_glyph_img('download', 16);
					glyph.setAttribute('alt', 'Download capture file');
					glyph.setAttribute('title', 'Download capture file');
					dom_set_child(down_a, glyph);
				}

				/* Capture file description */
				{
					var label_span = document.getElementById('toolbar_capture_description');
					var label_str = " " + data['filename'] + " (" + data['frames'] + " frames, " + data['duration'] + ' seconds, ' + data['filesize'] + " bytes)";
					dom_set_child(label_span, document.createTextNode(label_str));
				}

				/* TODO: link to download ssl-sessions  */

				if (opt['hide_menu'] == undefined)
				{
					create_tap_menu('report_menu', ws_taps);
					create_tap_menu('report_menu_conv', ws_convs);
					create_tap_menu('report_menu_srt', ws_srt);
					create_tap_menu('report_menu_srt', ws_rtd);
					create_tap_menu('report_menu_stat', ws_stats);
					create_tap_menu('report_menu_stat2', ws_nstat);
					create_tap_menu('report_menu_eo', ws_eo);
					create_tap_menu('report_menu', ws_follow);
					create_tap_menu('report_menu', ws_seqa);
				}

				set_filter(filter);

				});

			} else {
				document.title = "Capture files - " + document.title;

				/* Link to upload capture file */
				{
					var upload_a = document.createElement('a');
					upload_a.setAttribute("target", "_blank");
					upload_a.setAttribute("href", 'upload.html');
					upload_a.addEventListener("click", popup_on_click_a);

					var glyph = webshark_glyph_img('upload', 16);
					glyph.setAttribute('alt', 'Upload capture file');
					glyph.setAttribute('title', 'Upload capture file');

					upload_a.appendChild(glyph);

					var toolbar = document.getElementById('files_view');
					toolbar.insertBefore(upload_a, toolbar.childNodes[0]);
				}

				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';
				document.getElementById('ws_packet_detail_view').style.display = 'none';
				document.getElementById('ws_packet_bytes_view').style.display = 'none';

				document.getElementById('files_view').style.display = 'block';

				webshark_load_files(dir);
			}

			document.getElementById("ws_div").style.display = "block";
		}

		function filter_files(filter)
		{
			var rules = filter.split(" ");

			var frames_count_min = undefined;
			var frames_count_max = undefined;
			var duration_time_min = undefined;
			var duration_time_max = undefined;
			var filename_contain = [ ];
			var protocols = [ ];

			for (var i = 0; i < rules.length; i++)
			{
				var rule = rules[i];

				if (rule.indexOf('frames>') != -1)
					frames_count_min = rule.slice('frames>'.length);
				else if (rule.indexOf('frames<') != -1)
					frames_count_max = rule.slice('frames<'.length);
				else if (rule.indexOf('duration>') != -1)
					duration_time_min = rule.slice('duration>'.length);
				else if (rule.indexOf('duration<') != -1)
					duration_time_max = rule.slice('duration<'.length);
				else if (rule.indexOf('proto:') != -1)
					protocols.push(rule.slice('proto:'.length));
				else
					filename_contain.push(rule);
			}

			webshark_display_files(function(file)
			{
				var anal = file['analysis'];

				// TODO, what to do if there are no analysis?
				if (frames_count_min && (!anal || anal['frames'] <= frames_count_min))
					return false;

				if (frames_count_max && (!anal || anal['frames'] >= frames_count_max))
					return false;

				if (duration_time_min || duration_time_max)
				{
					if (!anal)
						return false;

					// TODO, what to do if there are no time analysis?
					var dura = anal['last'] - anal['first'];

					if (duration_time_min && dura <= duration_time_min)
						return false;

					if (duration_time_max && dura >= duration_time_max)
						return false;
				}

				for (var i = 0; i < filename_contain.length; i++)
				{
					if (file['name'].indexOf(filename_contain[i]) == -1)
						return false;
				}

				for (var i = 0; i < protocols.length; i++)
				{
					var found = false;
					var proto = protocols[i];

					for (var j = 0; found == false && j < (anal ? anal['protocols'].length : 0); j++)
					{
						if (proto == anal['protocols'][j])
							found = true;
					}

					if (found == false)
						return false;
				}

				return true;
			});
		}

		function load_preferences()
		{
			for (var key in ws_default_pref)
			{
				if (ws_pref[key] == undefined)
					ws_pref[key] = ws_default_pref[key];
			}
		}

		function render_interval(mode)
		{
			_webshark_interval_mode = mode;
			webshark_render_interval();
		}

		function bytes_display_base(new_base)
		{
			_webshark_hexdump_html.base = new_base;
			_webshark_hexdump_html.render_hexdump();
		}

		function show_hide_menu(id, id2)
		{
			var list = [ 'report_menu', 'report_menu_conv', 'report_menu_srt', 'report_menu_stat', 'report_menu_stat2', 'report_menu_eo' ];
			var elem;

			for (var i = 0; i < list.length; i++)
			{
				if (list[i] != id && list[i] != id2)
				{
					elem = document.getElementById(list[i]);
					elem.style['display'] = 'none';
				}
			}

			elem = document.getElementById(id);
			elem.style['display'] = (elem.style['display'] != 'block') ? 'block' : "none";
			if (id2 != undefined)
			{
				elem = document.getElementById(id2);
				elem.style['display'] = (elem.style['display'] != 'block') ? 'block' : "none";
			}
		}

		function load()
		{
			_webshark_url = '/webshark/json?';
			_webshark_interval_mode = "bps";

			_webshark_files_html = new Clusterize({
				rows: [],
				rows_in_block: 50,
				tag: 'tr',
				scrollId: 'capture_files_view',
				contentId: 'capture_files'
			});

			_webshark_frames_html = new Clusterize({
				rows: [],
				rows_in_block: 25,
				tag: 'tr',
				scrollId: 'ws_packet_list_view',
				contentId: 'packet_list_frames'
			});

			_webshark_prototree_html = new ProtocolTree({
				contentId: 'ws_packet_detail_view'
			});

			_webshark_hexdump_html = new Hexdump({
				base: 16,
				contentId: 'ws_bytes_dump'
			});

			load_preferences();

			_webshark = new Webshark();

			webshark_json_get(
				{
					req: 'info'
				},
				function(data)
				{
					ws_taps  = data['taps'];
					ws_stats = data['stats'];
					ws_nstat = data['nstat'];
					ws_eo    = data['eo'];
					ws_follow= data['follow'];
					ws_seqa  = data['seqa'];
					ws_srt   = data['srt'];
					ws_rtd   = data['rtd'];
					ws_convs = data['convs'];
					ws_ftypes = data['ftypes'];

					var columns_default = [ "%m", "%t", "%s", "%d", "%p", "%L", "%i" ];
					var columns_title   = [ ];
					var columns_pref    = [ ];

					document.title = document.title.replace("${WEBSHARK_VER}", data['version']);

					setup_user_toolbar(data['user']);

					for (var col = 0; col < ws_pref.columns.length; col++)
					{
						var col_title = "";
						var col_format = "";
						var col_format_idx = -1;

						for (col_title in ws_pref.columns[col]) { col_format = ws_pref.columns[col][col_title]; }
						columns_title.push(col_title);

						if (col >= columns_default.length || columns_default[col] != col_format)
						{
							_webshark.setColumns(columns_pref);
						}

						/* map from column format to integer */
						var ws_d_columns = data['columns'];
						for (var col_map = 0; col_map < ws_d_columns.length; col_map++)
						{
							if (ws_d_columns[col_map].format == col_format)
							{
								col_format_idx = col_map;
							}
						}

						if (col_format_idx != -1)
							columns_pref.push(col_format_idx);
						else
							columns_pref.push(col_format);
					}

					webshark_render_columns(columns_title);
					run();
				});
		}

	</script>
</head>

<body onload="load()"><div id="ws_div" style="display: none;">
	<div id="user_toolbar">
		<a href="/">Webshark</a>

		<div style="float: right; margin-right: 5px;">
			<span id="user_anon" style="display: none;">
				Guest
				<a href="/login">Login</a>
			</span>
			<span id="user_registered" style="display: none;">
				<span id="user_login"></span>
				<a href="/logout/?next=/webshark">Logout</a>
			</span>
		</div>
	</div>

	<div id="files_view" style="display: none;">
		<input id="files_filter" placeholder="Apply a files filter" type='text' onchange='filter_files(this.value);' style='width: 1000px;' />
		<p style="font-size: 12px;">Filter examples:
			<span class="example">filename</span>
			<span class="example">duration&lt;0.5 frames&gt;42</span>
			<span class="example">duration&gt;60 frames&lt;42</span>
			<span class="example">proto:tcp</span>
			<span class="example">proto:wlan proto:eap</span>
		</p>
		<div id="capture_files_view" style="max-height: 800px; overflow: auto; width: 70%; float: left;">
			<table style="width: 100%;">
				<thead id="capture_files_header">
					<tr>
						<th>Filename</th>
						<th>File Size</th>
						<th>Description</th>
					</tr>
				</thead>
				<tbody id="capture_files">
				</tbody>
			</table>
		</div>
		<div id="capture_files_view_details" style="max-height:700px; overflow: auto; width: 20%; float: left;">
			Click file to get details
		</div>
	</div>

	<div id="toolbar_capture">
		<div style="float: left;">
			<a id="toolbar_capture_files"></a>
			<a id="toolbar_capture_down"></a>
			<span id="toolbar_capture_description"></span>
			<p />
			<input id="capture_filter" placeholder="Apply a display filter" type='text' onchange='set_filter(this.value);' oninput='checkfilter(this)' style='width: 550px;' />

			<ul class="menul">
			<li>
				<a onclick="show_hide_menu('report_menu_conv');">Endpoints
					<div class="submenu" id="report_menu_conv"></div>
				</a>
				<a onclick="show_hide_menu('report_menu_srt');">Response Time
					<div class="submenu" id="report_menu_srt"></div>
				</a>
				<a onclick="show_hide_menu('report_menu_stat', 'report_menu_stat2');">Statistics
					<div class="submenu" id="report_menu_stat" style="margin-left: -200px;"></div>
					<div class="submenu" id="report_menu_stat2" style="margin-left: 200px;"></div>
				</a>
				<a onclick="show_hide_menu('report_menu_eo');">Export Objects
					<div class="submenu" id="report_menu_eo"></div>
				</a>
				<a onclick="show_hide_menu('report_menu');">Misc
					<div class="submenu" id="report_menu"></div>
				</a>
			</li>
		</ul>
		</div>
		<div style="float: right; border: 1px solid grey;">
			<input type="radio" name="interval_mode" onchange="render_interval('bps')" value="bps" checked="checked"> bytes/seconds
			<input type="radio" name="interval_mode" onchange="render_interval('fps')" value="fps"> frames/seconds
			<div id="capture_interval" style="margin-top: 2px;">
				<svg width="620" height="100"></svg>
			</div>
		</div>
		<div style="clear: both;"></div>
	</div>

	<div id="toolbar_tap" style="display: none;">
		Placeholder for taps toolbar
		<div id="ws_tap_graph" style="width: 2000px; overflow-x: auto;"></div>
		<div id="ws_tap_extra" style="display: none; height: 700px;"></div>
		<div id="ws_tap_table" style="max-height: 550px; overflow-y: auto; border: 2px solid grey;"></div>
		<div id="ws_tap_details" style="display: none; max-height: 500px; overflow-y: auto;"></div>
	</div>

	<div id="ws_packet_list_view" style='height: 350px; overflow: auto; border: 2px solid grey;'>
		<table id="packet_list" style="width: 100%;">
			<thead id="packet_list_header">
				<!-- <tr><th>No.</th></tr> -->
			</thead>
			<tbody id="packet_list_frames">
				<!--- <tr><td>1</td><td>2h</td></tr> -->
			</tbody>
		</table>
	</div>

	<div id="toolbar_frame" style="display: none;">
		<a id="toolbar_frame_comment"></a>
		<input id="field_filter" placeholder="Apply a field filter" type='text' onchange='set_field_filter(this.value);' style='width: 350px;' />
	</div>

	<div id="ws_packet_detail_view" style='overflow: auto; width: 100%; height: 250px; border: 2px solid grey; float: left;'>
Select frame
	</div>

	<div id="ws_packet_bytes_view" style='overflow: auto; width: 100%; height: 200px; border: 2px solid grey; float: right;'>
		<div id="ws_packet_pane" style="float: right;"></div>
		<input type="radio" name="bytes_mode" onchange="bytes_display_base(16)" value="16" checked="checked"> Hex view
		<input type="radio" name="bytes_mode" onchange="bytes_display_base(2)" value="2"> Bits view
		<pre id='ws_bytes_dump'>Select frame</pre>
	</div>

</div></body>
</html>
