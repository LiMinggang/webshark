<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">

	<title>${CAPTURE_FILE} - webshark ${WEBSHARK_VER}</title>

	<link rel="stylesheet" href="css/webshark.css" type="text/css">

	<script src="js/d3.v4.min.js" type="text/javascript"></script>
	<script src="js/webshark.js" type="text/javascript"></script>

	<script type="text/javascript">
		var ws_stats = [ ];
		var ws_convs = [ ];

		function create_tap_menu(id, taps)
		{
			var node = document.getElementById(id);

			for (var i = 0; i < taps.length; i++)
			{
				var li = document.createElement("li");
				var a = document.createElement("a");

				var title = taps[i].name;
				var tap = taps[i].tap;

				a.appendChild(document.createTextNode(title));
				a.setAttribute("target", "_blank");
				a.setAttribute("href", window.location.href + "&tap=" + tap);
				// a.addEventListener("click", popup_on_click);

				li.appendChild(a);
				node.appendChild(li);
			}
		}

		function parse_query(query)
		{
			var result = { };

			if (query)
			{
				var opts = query.split("&");
				for (var i = 0; i < opts.length; i++)
				{
					var arr = opts[i].split("=");
					result[arr[0]] = decodeURIComponent(arr[1]);
				}
			}

			return result;
		}

		function checkfilter(el)
		{
			if (el.value == '')
			{
				el.className = '';
				return;
			}

			webshark_json_get('req=check&filter=' + encodeURIComponent(el.value),
				function(data)
				{
					if (data['filter'] == 'ok')
						el.className = 'ws_gui_text_valid';
					else if (data['filter'] == 'deprecated')
						el.className = 'ws_gui_text_deprecated';
					else
						el.className = 'ws_gui_text_invalid';
				});
		}

		function run()
		{
			var opt = parse_query(window.location.href.split("?")[1]);

			_webshark_file = opt['file'];

			var frame = opt['frame'];
			var tap = opt['tap'];

			if (tap) {
				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';
				document.getElementById('ws_packet_detail_view').style.display = 'none';
				document.getElementById('ws_packet_bytes_view').style.display = 'none';

				document.getElementById('toolbar_tap').style.display = 'block';

				webshark_load_tap(tap.split(","));

			} else if (frame) {
				webshark_load_frame(frame);

				document.getElementById('toolbar_capture').style.display = 'none';
				document.getElementById('ws_packet_list_view').style.display = 'none';

				document.getElementById('toolbar_frame').style.display = 'block';

			} else {
				var filter = opt['filter'];

				create_tap_menu('cap_menu', ws_stats);
				create_tap_menu('cap_menu', ws_convs);

				webshark_load_capture(filter);
			}
		}

		function load()
		{
			_webshark_url = '/webshark/json?';

			webshark_json_get('req=info',
				function(data)
				{
					webshark_render_columns(data['columns']);
					ws_stats = data['stats'];
					ws_convs = data['convs'];
					run();
				});
		}

	</script>
</head>

<body onload="load()">
	<div id="toolbar_capture">
		<ul class="menu" id="cap_menu"></ul>
		<div style="clear: both;"></div>
		Frame filter: <input id="filter" type='text' onchange='webshark_load_capture(this.value);' onkeyup='checkfilter(this)' style='width: 600px;' />
	</div>

	<div id="toolbar_frame" style="display: none;">
		Placeholder for frame toolbar
	</div>

	<div id="toolbar_tap" style="display: none;">
		Placeholder for taps toolbar
	</div>

	<div id="ws_packet_list_view" style='height: 350px; overflow: auto; border: 2px solid grey;'>
		<table id="packet_list" style="width: 100%;">
			<thead id="packet_list_header">
				<!-- <tr><th>No.</th></tr> -->
			</thead>
			<tbody id="packet_list_frames">
				<!--- <tr><td>1</td><td>2h</td></tr> -->
			</tbody>

		</table>
	</div>

	<div id="ws_packet_detail_view" style='overflow: auto; width: 100%; height: 250px; border: 2px solid grey;'>
Select frame
	</div>

	<div id="ws_packet_bytes_view" style='overflow: auto; width: 100%; height: 200px; border: 2px solid grey;'>
Select frame
	</div>

</body>
</html>
